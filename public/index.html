<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thompson Transportation Freight Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Caveat:wght@700&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&family=Roboto:wght@400;500;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    <script>
        // Apply dark mode immediately
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #cce7ff; transition: background-color 0.3s; }
        .dark body { background-color: #0d1a26; }
        .input-label { font-family: 'Merriweather', serif; font-size: 1rem; color: #003366; }
        .dark .input-label { color: #aaccff; }
        .editable-field { background-color: white; color: #111827; border: 2px solid #d1d5db; }
        .dark .editable-field { background-color: #374151; color: white; border-color: #4b5563; }
        .output-field { background-color: #e0e7ff; color: #111827; border: 2px solid #d1d5db; }
        .dark .output-field { background-color: #1e3a5f; color: #e0e7ff; border-color: #4b5563; }
        /* menu, buttons, retro, print styles retained */
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 overflow-x-hidden">

  <!-- Full UI including menu omitted here for brevity -->
  <div id="calculator-ui" class="w-full max-w-2xl bg-white/30 dark:bg-black/20 backdrop-blur-lg border border-white/50 dark:border-white/10 p-6 rounded-2xl shadow-lg">
    <div class="text-center mb-4">
      <h2 id="main-title" class="main-title text-2xl font-bold">Thompson Transportation</h2>
      <h1 class="calculator-title text-4xl font-bold text-[#003366] dark:text-blue-200 mt-1">Freight Calculator</h1>
    </div>

    <!-- Map Container -->
    <div id="pcmiler-map" class="w-full h-64 border-4 border-black bg-white mb-6 flex items-center justify-center">
      <span class="text-gray-500">PC Miler Route Map</span>
    </div>

    <!-- Mode Selector -->
    <div id="mode-selector-container" class="relative grid grid-cols-3 gap-2 mb-6 p-1 rounded-lg bg-gray-100 dark:bg-gray-800">
      <div id="mode-slider" class="absolute top-1 bottom-1 left-1 w-1/3 bg-blue-500 dark:bg-blue-300 rounded-md transition-all"></div>
      <button data-mode="generateQuote" class="mode-btn py-2 text-sm">Generate Quote</button>
      <button data-mode="calculateFromTon" class="mode-btn py-2 text-sm">Calc from Ton</button>
      <button data-mode="calculateFromFlat" class="mode-btn py-2 text-sm">Calc from Flat</button>
    </div>

    <!-- Calculator Form -->
    <form id="rateCalculatorForm" class="space-y-4">
      <div class="flex items-center justify-between">
        <label for="ratePerTon" class="input-label">Rate ($/Ton)</label>
        <input type="number" id="ratePerTon" step="0.01" placeholder="3.50" class="editable-field w-48 p-2 text-right" />
      </div>
      <div class="flex items-center justify-between">
        <label for="tonnage" class="input-label">Tonnage</label>
        <input type="number" id="tonnage" step="0.1" value="23" class="editable-field w-48 p-2 text-right" />
      </div>
      <div class="flex items-center justify-between">
        <label for="fsc" class="input-label">FSC (%)</label>
        <input type="number" id="fsc" step="0.1" placeholder="10" class="editable-field w-48 p-2 text-right" />
      </div>
      <div class="grid grid-cols-3 gap-4">
        <div class="flex flex-col">
          <label for="leg1Origin" class="input-label">Prev Delivery</label>
          <input type="text" id="leg1Origin" placeholder="e.g. Little Rock, AR" class="editable-field p-2" />
        </div>
        <div class="flex flex-col">
          <label for="leg1Dest" class="input-label">Pickâ€‘Up</label>
          <input type="text" id="leg1Dest" placeholder="e.g. Dallas, TX" class="editable-field p-2" />
        </div>
        <div class="flex flex-col">
          <label for="leg2Dest" class="input-label">Final Delivery</label>
          <input type="text" id="leg2Dest" placeholder="e.g. Houston, TX" class="editable-field p-2" />
        </div>
      </div>
      <div class="flex items-center justify-between">
        <label for="miles" class="input-label">Total Miles</label>
        <input type="number" id="miles" readonly class="output-field w-48 p-2 text-right opacity-50 cursor-not-allowed" />
      </div>
      <hr class="border-gray-300 dark:border-gray-600" />
      <div class="flex items-center justify-between">
        <label for="quotePerMile" class="input-label">Calc Rate ($/Mile)</label>
        <input type="text" id="quotePerMile" readonly class="output-field w-48 p-2 text-right" />
      </div>
      <div class="flex items-center justify-between">
        <label for="fscTotal" class="input-label">FSC Total ($)</label>
        <input type="text" id="fscTotal" readonly class="output-field w-48 p-2 text-right" />
      </div>
      <div class="flex items-center justify-between">
        <label for="finalTotal" class="input-label">Final Total ($)</label>
        <input type="text" id="finalTotal" readonly class="output-field w-48 p-2 text-right" />
      </div>
      <div class="flex justify-center space-x-4 pt-4">
        <button type="button" id="emailBtn" class="action-btn btn-email">Email</button>
        <button type="button" id="printBtn" class="action-btn btn-print">Print</button>
        <button type="button" id="copyBtn" class="action-btn btn-copy">Copy</button>
        <button type="button" id="resetBtn" class="action-btn btn-reset">Reset</button>
      </div>
      <p id="copyNotification" class="text-center text-green-700 dark:text-green-400 font-semibold mt-2 h-6 opacity-0 transition-opacity"></p>
    </form>
  </div>

  <script>
    // Insert your PC Miler API key below
    const API_KEY = 'C9EC4E502D8E6349AB91A8FF5BA8C66F';
    if (!API_KEY || API_KEY.startsWith('REPLACE')) {
      console.error('Please set your PC Miler API key in the API_KEY constant.');
    }

    const ratePerTon    = document.getElementById('ratePerTon');
    const tonnageInput  = document.getElementById('tonnage');
    const fscInput      = document.getElementById('fsc');
    const leg1Origin    = document.getElementById('leg1Origin');
    const leg1Dest      = document.getElementById('leg1Dest');
    const leg2Dest      = document.getElementById('leg2Dest');
    const milesInput    = document.getElementById('miles');
    const quotePerMile  = document.getElementById('quotePerMile');
    const fscTotal      = document.getElementById('fscTotal');
    const finalTotal    = document.getElementById('finalTotal');
    const pcmilerMapDiv = document.getElementById('pcmiler-map');
    const emailBtn      = document.getElementById('emailBtn');
    const printBtn      = document.getElementById('printBtn');
    const copyBtn       = document.getElementById('copyBtn');
    const resetBtn      = document.getElementById('resetBtn');
    const copyNotification = document.getElementById('copyNotification');
    const modeButtons   = Array.from(document.querySelectorAll('.mode-btn'));
    const modeSlider    = document.getElementById('mode-slider');
    let currentMode     = 'generateQuote';

    async function getDistance(from, to) {
      if (!API_KEY || API_KEY.startsWith('REPLACE')) {
        throw new Error('Missing PC Miler API key');
      }
      const res = await fetch('https://api.pcmiler.com/v1/route', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${API_KEY}`
        },
        body: JSON.stringify({ origin: from, destination: to })
      });
      if (!res.ok) {
        throw new Error(`Distance fetch failed: ${res.status} ${res.statusText}`);
      }
      const data = await res.json();
      return data.distanceMiles;
    }

    async function updateRouteAndMiles() {
      const a = leg1Origin.value.trim();
      const b = leg1Dest.value.trim();
      const c = leg2Dest.value.trim();
      if (!a || !b || !c) return;
      milesInput.value = '...';
      try {
        const [d1, d2] = await Promise.all([getDistance(a, b), getDistance(b, c)]);
        const total = d1 + d2;
        milesInput.value = total.toFixed(1);
        calculateCosts(total);
        // Optionally render map if API returns a URL
        // pcmilerMapDiv.innerHTML = `<img src="${data.mapUrl}" class="w-full h-full object-contain"/>`;
      } catch (err) {
        console.error(err);
        alert('Distance lookup failed. Check your API key or network.');
        milesInput.value = '';
        milesInput.removeAttribute('readonly');
        milesInput.classList.remove('opacity-50');
      }
    }

    function calculateCosts(miles) {
      const rt = parseFloat(ratePerTon.value) || 0;
      const tn = parseFloat(tonnageInput.value) || 0;
      const fp = parseFloat(fscInput.value) || 0;
      const lh = rt * tn;
      const fa = lh * (fp / 100);
      const total = lh + fa;
      const rm = miles > 0 ? total / miles : 0;
      quotePerMile.value = rm.toFixed(2);
      fscTotal.value     = fa.toFixed(2);
      finalTotal.value   = total.toFixed(2);
    }

    function setMode(m) {
      currentMode = m;
      modeButtons.forEach(btn => btn.classList.remove('active'));
      const btn = modeButtons.find(b => b.dataset.mode === m);
      btn.classList.add('active');
      modeSlider.style.width = btn.offsetWidth + 'px';
      modeSlider.style.transform = `translateX(${btn.offsetLeft}px)`;
      emailBtn.classList.toggle('hidden', m !== 'generateQuote');
      printBtn.classList.toggle('hidden', m === 'generateQuote');
    }
    modeButtons.forEach(b => b.addEventListener('click', () => setMode(b.dataset.mode)));
    setMode(currentMode);

    [ratePerTon, tonnageInput, fscInput].forEach(el => el.addEventListener('input', () => {
      calculateCosts(parseFloat(milesInput.value) || 0);
    }));
    [leg1Origin, leg1Dest, leg2Dest].forEach(el => el.addEventListener('change', updateRouteAndMiles));

    copyBtn.addEventListener('click', () => {
      const txt = `Miles: ${milesInput.value}\nRate/Mile: ${quotePerMile.value}\nFSC Amt: ${fscTotal.value}\nTotal: ${finalTotal.value}`;
      navigator.clipboard.writeText(txt);
      copyNotification.textContent = 'Copied!';
      copyNotification.style.opacity = 1;
      setTimeout(() => copyNotification.style.opacity = 0, 2000);
    });
    resetBtn.addEventListener('click', () => location.reload());
    emailBtn.addEventListener('click', () => {
      const subj = 'Freight Quote';
      const body = `Rate: ${quotePerMile.value}/mi\nTotal: ${finalTotal.value}`;
      location.href = `mailto:?subject=${encodeURIComponent(subj)}&body=${encodeURIComponent(body)}`;
    });
    printBtn.addEventListener('click', () => window.print());

    // Kickoff initial
    updateRouteAndMiles();
  </script>
</body>
</html>
