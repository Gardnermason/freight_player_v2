<!DOCTYPE html>
<html lang="en" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Thompson Transportation – Freight Calculator (PC*Miler enabled)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Caveat:wght@700&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&family=Roboto:wght@400;500;700&family=Press+Start+2P&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <!-- Leaflet for map rendering (no API key required) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // Apply dark mode immediately
    if (
      localStorage.getItem("theme") === "dark" ||
      (!("theme" in localStorage) && window.matchMedia("(prefers-color-scheme: dark)").matches)
    ) {
      document.documentElement.classList.add("dark");
    } else {
      document.documentElement.classList.remove("dark");
    }
  </script>
  <style>
    body {
      font-family: "Roboto", sans-serif;
      background-color: #cce7ff;
      background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.59l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/svg%3E");
      background-attachment: fixed;
      transition: background-color 0.3s ease;
    }
    .dark body {
      background-color: #0d1a26;
      background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.59l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/svg%3E");
    }
    .main-title {
      font-family: "Bungee", sans-serif;
      color: #dc2626;
      transition: color 0.3s ease-in-out;
      cursor: pointer;
    }
    .dark .main-title {
      color: #60a5fa;
    }
    .calculator-title {
      font-family: "Caveat", cursive;
    }
    .input-label {
      font-family: "Merriweather", serif;
      font-size: 1.1rem;
      color: #003366;
    }
    .dark .input-label {
      color: #aaccff;
    }
    .output-label {
      font-family: "Merriweather", serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #003366;
    }
    .dark .output-label {
      color: #aaccff;
    }
    .form-input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.5);
      border-color: #007bff !important;
    }
    .editable-field {
      background-color: white;
      color: #111827;
      border-color: #d1d5db;
    }
    .dark .editable-field {
      background-color: #374151;
      color: white;
      border-color: #4b5563;
    }
    .output-field {
      background-color: #e0e7ff;
      font-weight: bold;
      border-color: #d1d5db;
    }
    .dark .output-field {
      background-color: #1e3a5f;
      color: #e0e7ff;
      border-color: #4b5563;
    }
    #side-menu {
      transition: transform 0.3s ease-in-out;
    }
    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 700;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease-in-out;
    }
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1);
    }
    .btn-email {
      background-image: linear-gradient(to right, #8b5cf6, #a855f7);
    }
    .btn-print {
      background-image: linear-gradient(to right, #16a34a, #22c55e);
    }
    .btn-copy {
      background-image: linear-gradient(to right, #2563eb, #3b82f6);
    }
    .btn-reset {
      background-image: linear-gradient(to right, #dc2626, #ef4444);
    }
    #mode-selector-container {
      background-color: #dbeafe;
    }
    .dark #mode-selector-container {
      background-color: #1f2937;
    }
    .mode-btn {
      color: #1e40af;
      transition: color 0.3s;
      z-index: 10;
    }
    .dark .mode-btn {
      color: #aaccff;
    }
    .mode-btn.active {
      color: white;
    }
    .dark .mode-btn.active {
      color: #0d1a26;
    }
    #mode-slider {
      background-color: #3b82f6;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 5;
    }
    .dark #mode-slider {
      background-color: #60a5fa;
    }
    /* Retro mode */
    .retro-mode body {
      background-image: none !important;
      background-color: #000 !important;
      font-family: "Press Start 2P", cursive !important;
    }
    .retro-mode #calculator-card {
      background: #000 !important;
      border: 4px solid #4ade80 !important;
      box-shadow: none !important;
      border-radius: 0 !important;
    }
    .retro-mode .main-title,
    .retro-mode .calculator-title,
    .retro-mode .input-label,
    .retro-mode .output-label,
    .retro-mode .mode-btn {
      color: #4ade80 !important;
      text-shadow: 2px 2px #000;
    }
    .retro-mode .editable-field,
    .retro-mode .output-field,
    .retro-mode #mode-selector-container {
      background-color: #000 !important;
      color: #4ade80 !important;
      border: 2px solid #4ade80 !important;
    }
    .retro-mode #mode-slider {
      background-color: #4ade80 !important;
    }
    .retro-mode .action-btn {
      background-image: none !important;
      background-color: #4ade80 !important;
      color: #000 !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }
    .retro-mode hr {
      border-color: #4ade80 !important;
    }
    @media print {
      body,
      html {
        background-color: white !important;
      }
      #calculator-card,
      #side-menu,
      #menu-overlay {
        display: none !important;
      }
      .print-area {
        display: block !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
      }
      .print-area-content {
        background: white !important;
        color: black !important;
        -webkit-print-color-adjust: exact;
        color-adjust: exact;
      }
      .print-area-content * {
        color: black !important;
      }
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 overflow-x-hidden">
  <!-- Transition Canvas -->
  <canvas id="transition-canvas" class="fixed inset-0 w-full h-full z-50 pointer-events-none hidden"></canvas>
  <!-- Menu Overlay -->
  <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>
  <!-- Side Menu -->
  <div id="side-menu" class="fixed top-0 left-0 h-full w-80 bg-white dark:bg-gray-800 shadow-xl z-40 transform -translate-x-full">
    <div class="p-5 flex flex-col h-full">
      <div>
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-[#003366] dark:text-blue-200">Menu</h2>
          <button id="close-menu-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
            <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <nav id="main-menu" class="space-y-1">
          <a href="#" id="history-menu-btn" class="flex items-center p-3 text-lg text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Recent Calculations
          </a>
          <a href="#" id="theme-toggle" class="flex items-center p-3 text-lg text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <svg id="theme-toggle-dark-icon" class="hidden w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
            <svg id="theme-toggle-light-icon" class="hidden w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0z" fill-rule="evenodd" clip-rule="evenodd"/></svg>
            Night Shift
          </a>
          <a href="#" id="feedback-menu-btn" class="flex items-center p-3 text-lg text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            Send Feedback
          </a>
          <a href="#" id="samples-menu-btn" class="flex items-center p-3 text-lg text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
            <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18"/></svg>
            Sample Routes (Tests)
          </a>
        </nav>
      </div>
      <div class="flex-grow"></div>
      <div class="mt-auto p-4 border-t border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-center text-[#003366] dark:text-blue-200">Calculation Counter</h3>
        <p id="personal-calc-counter" class="text-4xl font-bold text-center text-blue-600 dark:text-blue-400 mt-2">0</p>
        <p class="text-center text-xs text-gray-400 dark:text-gray-500 mt-2">Version 3.1</p>
      </div>
      <!-- History View -->
      <div id="history-view" class="hidden absolute inset-0 bg-white dark:bg-gray-800 p-5">
        <div class="flex justify-between items-center mb-4">
          <button id="back-to-menu-hist" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
            <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          </button>
          <h3 class="text-xl font-bold text-center text-[#003366] dark:text-blue-200">History</h3>
          <div class="w-6"></div>
        </div>
        <div id="history-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
        <button id="clear-history-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Clear History</button>
      </div>
      <!-- Feedback View -->
      <div id="feedback-view" class="hidden absolute inset-0 bg-white dark:bg-gray-800 p-5">
        <div class="flex justify-between items-center mb-4">
          <button id="back-to-menu-feed" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
            <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          </button>
          <h3 class="text-xl font-bold text-center text-[#003366] dark:text-blue-200">Feedback</h3>
          <div class="w-6"></div>
        </div>
        <form id="feedback-form" class="space-y-4">
          <textarea id="feedback-message" placeholder="Your feedback..." rows="5" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700"></textarea>
          <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Send</button>
        </form>
      </div>
      <!-- Samples View (Test Cases) -->
      <div id="samples-view" class="hidden absolute inset-0 bg-white dark:bg-gray-800 p-5">
        <div class="flex justify-between items-center mb-4">
          <button id="back-to-menu-samples" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
            <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          </button>
          <h3 class="text-xl font-bold text-center text-[#003366] dark:text-blue-200">Sample Routes (Tests)</h3>
          <div class="w-6"></div>
        </div>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Click a sample to auto-fill the three stops and fetch PC*Miler miles.</p>
        <div class="space-y-2">
          <button data-sample='{"a":"Little Rock, AR","b":"Dallas, TX","c":"Houston, TX"}' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Little Rock → Dallas → Houston</button>
          <button data-sample='{"a":"Memphis, TN","b":"Birmingham, AL","c":"Atlanta, GA"}' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Memphis → Birmingham → Atlanta</button>
          <button data-sample='{"a":"Tulsa, OK","b":"Oklahoma City, OK","c":"Amarillo, TX"}' class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Tulsa → Oklahoma City → Amarillo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calculator Card -->
  <div id="calculator-card" class="w-full max-w-3xl mx-auto bg-white/30 dark:bg黑/20 backdrop-blur-lg border border-white/50 dark:border-white/10 p-8 rounded-2xl shadow-[0_10px_30px_rgba(0,0,0,0.2)] dark:shadow-[0_10px_30px_rgba(0,0,0,0.5)] transition-all duration-300">
    <div class="flex justify-between items-center mb-4">
      <div class="w-8">
        <button id="open-menu-btn" type="button" class="p-1 text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
      </div>
      <div class="text-center">
        <h2 id="main-title" class="main-title text-3xl font-bold">Thompson Transportation</h2>
        <h1 class="calculator-title text-5xl font-bold text-[#003366] dark:text-blue-200 mt-1">Freight Calculator</h1>
      </div>
      <div class="w-8"></div>
    </div>

    <!-- PC*Miler Map Container -->
    <div id="pcmiler-map" class="w-full h-80 border-4 border-black bg-white mb-6 relative">
      <div id="map" class="absolute inset-0"></div>
      <div id="map-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500">PC*Miler Route Map</div>
    </div>

    <!-- Mode Selector -->
    <div id="mode-selector-container" class="relative grid grid-cols-3 gap-2 mb-6 p-1 rounded-lg">
      <div id="mode-slider" class="absolute top-1 bottom-1 left-1 w-1/3 rounded-md"></div>
      <button type="button" data-mode="generateQuote" class="mode-btn py-2 px-1 rounded-md text-sm sm:text-base active">Generate Quote</button>
      <button type="button" data-mode="calculateFromTon" class="mode-btn py-2 px-1 rounded-md text-sm sm:text-base">Calc from Ton</button>
      <button type="button" data-mode="calculateFromFlat" class="mode-btn py-2 px-1 rounded-md text-sm sm:text-base">Calc from Flat</button>
    </div>

    <form id="rateCalculatorForm" class="space-y-5">
      <!-- Primary Input (label changes by mode) -->
      <div id="primaryInputSection">
        <div class="flex items-center justify-between space-x-4">
          <label for="primaryInput" id="primaryInputLabel" class="input-label transition-opacity duration-300">Your Rate ($/Mile)</label>
          <div class="relative w-48">
            <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400 dark:text-gray-500">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"/></svg>
            </span>
            <input type="number" id="primaryInput" step="0.01" placeholder="e.g., 3.50" class="form-input editable-field w-full p-3 pl-10 text-lg text-right font-semibold border-2 rounded-lg shadow-inner" />
          </div>
        </div>
      </div>

      <!-- Three Location Boxes -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="flex flex-col">
          <label for="leg1Origin" class="input-label">Prev Delivery</label>
          <input type="text" id="leg1Origin" placeholder="e.g. Little Rock, AR" class="editable-field p-3 rounded-lg" />
        </div>
        <div class="flex flex-col">
          <label for="leg1Dest" class="input-label">Pick‑Up</label>
          <input type="text" id="leg1Dest" placeholder="e.g. Dallas, TX" class="editable-field p-3 rounded-lg" />
        </div>
        <div class="flex flex-col">
          <label for="leg2Dest" class="input-label">Final Delivery</label>
          <input type="text" id="leg2Dest" placeholder="e.g. Houston, TX" class="editable-field p-3 rounded-lg" />
        </div>
      </div>

      <!-- Total Miles (auto-filled from PC*Miler, but can be edited on failure) -->
      <div class="flex items-center justify-between space-x-4">
        <label for="miles" class="input-label">Total Miles</label>
        <div class="relative w-48">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400 dark:text-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 3v18m8-18v18m-4-6h.01M10 9h.01M14 6h.01M14 15h.01"/></svg>
          </span>
          <input type="number" id="miles" step="0.1" placeholder="e.g., 500" class="form-input editable-field w-full p-3 pl-10 text-lg text-right font-semibold border-2 rounded-lg shadow-inner" readonly />
        </div>
      </div>

      <!-- Tonnage & FSC -->
      <div class="flex items-center justify-between space-x-4">
        <label for="tonnage" class="input-label">Tonnage</label>
        <div class="relative w-48">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400 dark:text-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 20V12a6 6 0 1112 0v8m-12 0h12m-9-14V5a3 3 0 016 0v1"/></svg>
          </span>
          <input type="number" id="tonnage" step="0.1" value="23" class="form-input editable-field w-full p-3 pl-10 text-lg text-right font-semibold border-2 rounded-lg shadow-inner" />
        </div>
      </div>
      <div class="flex items-center justify-between space-x-4">
        <label for="fsc" class="input-label">FSC (%)</label>
        <div class="relative w-48">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400 dark:text-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg>
          </span>
          <input type="number" id="fsc" placeholder="e.g., 10" class="form-input editable-field w-full p-3 pl-10 text-lg text-right font-semibold border-2 rounded-lg shadow-inner" />
        </div>
      </div>

      <hr class="border-t-2 border-gray-300 dark:border-gray-600 my-5" />

      <!-- Outputs -->
      <div class="flex items-center justify-between space-x-4">
        <label for="primaryOutput" id="primaryOutputLabel" class="output-label transition-opacity duration-300">Quote ($/Ton)</label>
        <div class="relative w-48">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400 dark:text-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"/></svg>
          </span>
          <input type="text" id="primaryOutput" readonly class="form-input output-field w-full p-3 pl-10 text-lg text-right border-2 rounded-lg shadow-inner cursor-not-allowed" />
        </div>
      </div>
      <div class="flex items-center justify-between space-x-4">
        <label class="output-label">FSC Total</label>
        <div class="relative w-48">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400 dark:text-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"/></svg>
          </span>
          <input type="text" id="fscTotalOut" readonly class="form-input output-field w-full p-3 pl-10 text-lg text-right border-2 rounded-lg shadow-inner cursor-not-allowed" />
        </div>
      </div>
      <div class="flex items-center justify-between space-x-4">
        <label class="output-label">Final Total</label>
        <div class="relative w-48">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none text-gray-400 dark:text-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"/></svg>
          </span>
          <input type="text" id="finalTotalOut" readonly class="form-input output-field w-full p-3 pl-10 text-lg text-right border-2 rounded-lg shadow-inner cursor-not-allowed" />
        </div>
      </div>

      <div class="flex items-center justify-center space-x-2 pt-5">
        <button type="button" id="emailButton" class="action-btn btn-email">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          Email
        </button>
        <button type="button" id="printButton" class="action-btn btn-print hidden">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
          Print
        </button>
        <button type="button" id="copyButton" class="action-btn btn-copy">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          Copy
        </button>
        <button type="button" id="resetButton" class="action-btn btn-reset">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          Reset
        </button>
      </div>
      <div id="copyNotification" class="text-center text-green-700 dark:text-green-400 font-semibold mt-2 h-6 opacity-0 transition-opacity duration-300"></div>
    </form>
  </div>

  <!-- Printable Area -->
  <div class="print-area hidden">
    <div class="print-area-content p-8">
      <h1 class="text-2xl font-bold mb-2">Thompson Transportation</h1>
      <h2 class="text-xl font-semibold mb-6 border-b pb-2">Freight Calculation Summary</h2>
      <p class="mb-2 text-lg"><strong class="w-48 inline-block">Date:</strong> <span id="print-date"></span></p>
      <p class="mb-2 text-lg"><strong class="w-48 inline-block">Calculation Mode:</strong> <span id="print-mode"></span></p>
      <p class="mb-2 text-lg"><strong class="w-48 inline-block">Prev Delivery → Pickup → Delivery:</strong> <span id="print-stops"></span></p>
      <p class="mb-2 text-lg"><strong class="w-48 inline-block">Total Miles:</strong> <span id="print-miles"></span></p>
      <p class="mb-2 text-lg"><strong class="w-48 inline-block">Tonnage:</strong> <span id="print-tonnage"></span></p>
      <p class="mb-2 text-lg"><strong class="w-48 inline-block">FSC (%):</strong> <span id="print-fsc"></span></p>
      <hr class="my-4" />
      <p class="mb-2 text-lg" id="print-your-rate-row"><strong class="w-48 inline-block"></strong> <span id="print-your-rate"></span></p>
      <p class="mb-2 text-lg" id="print-offer-row"><strong class="w-48 inline-block"></strong> <span id="print-offer"></span></p>
      <hr class="my-4" />
      <p class="mb-2 text-lg"><strong class="w-48 inline-block">FSC Total:</strong> <span id="print-fsc-total"></span></p>
      <p class="text-xl font-bold mt-4"><strong class="w-48 inline-block">Final Total:</strong> <span id="print-final-total"></span></p>
    </div>
  </div>

  <textarea id="copySource" class="sr-only"></textarea>

  <script>
    // ====== CONFIG ======
    const API_KEY = 'C9EC4E502D8E6349AB91A8FF5BA8C66F';

    // ====== DOM ======
    const form = document.getElementById('rateCalculatorForm');
    const primaryInput = document.getElementById('primaryInput');
    const primaryInputLabel = document.getElementById('primaryInputLabel');
    const primaryOutput = document.getElementById('primaryOutput');
    const fscTotalOut = document.getElementById('fscTotalOut');
    const finalTotalOut = document.getElementById('finalTotalOut');

    const milesInput = document.getElementById('miles');
    const tonnageInput = document.getElementById('tonnage');
    const fscInput = document.getElementById('fsc');

    const leg1Origin = document.getElementById('leg1Origin');
    const leg1Dest   = document.getElementById('leg1Dest');
    const leg2Dest   = document.getElementById('leg2Dest');

    const copyButton = document.getElementById('copyButton');
    const resetButton = document.getElementById('resetButton');
    const printButton = document.getElementById('printButton');
    const emailButton = document.getElementById('emailButton');
    const copyNotification = document.getElementById('copyNotification');
    const copySource = document.getElementById('copySource');
    const transitionCanvas = document.getElementById('transition-canvas');
    const mainTitle = document.getElementById('main-title');

    // Menu elements
    const openMenuBtn = document.getElementById('open-menu-btn');
    const closeMenuBtn = document.getElementById('close-menu-btn');
    const sideMenu = document.getElementById('side-menu');
    const menuOverlay = document.getElementById('menu-overlay');
    const mainMenu = document.getElementById('main-menu');
    const historyView = document.getElementById('history-view');
    const feedbackView = document.getElementById('feedback-view');
    const samplesView = document.getElementById('samples-view');
    const historyMenuBtn = document.getElementById('history-menu-btn');
    const feedbackMenuBtn = document.getElementById('feedback-menu-btn');
    const samplesMenuBtn = document.getElementById('samples-menu-btn');
    const backToMenuHist = document.getElementById('back-to-menu-hist');
    const backToMenuFeed = document.getElementById('back-to-menu-feed');
    const backToMenuSamples = document.getElementById('back-to-menu-samples');
    const historyList = document.getElementById('history-list');
    const clearHistoryBtn = document.getElementById('clear-history-btn');
    const feedbackForm = document.getElementById('feedback-form');
    const personalCalcCounter = document.getElementById('personal-calc-counter');

    // Mode selector
    const modeSelectorContainer = document.getElementById('mode-selector-container');
    const modeSlider = document.getElementById('mode-slider');
    const modeButtons = Array.from(modeSelectorContainer.querySelectorAll('.mode-btn'));
    let currentMode = 'generateQuote';

    // History
    let calculationHistory = JSON.parse(localStorage.getItem('thompsonCalcHistory')) || [];
    let personalCalcCount = parseInt(localStorage.getItem('thompsonPersonalCalcCount')) || 0;

    // ====== Konami & fun bits ======
    const konamiCode = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
    let konamiIndex = 0;
    async function playRetroMusic(){
      await Tone.start();
      const synth = new Tone.PolySynth(Tone.Synth,{ oscillator:{type:'square'}, envelope:{attack:.01,decay:.1,sustain:.2,release:.1}}).toDestination();
      const now = Tone.now();
      ['C#3','G#2','C#3','G#2','C#3','F2','C#3','F2'].forEach((n,i)=>synth.triggerAttackRelease(n,'8n',now+i*0.25));
    }
    async function playPowerDownSound(){
      await Tone.start();
      const s = new Tone.Synth({oscillator:{type:'sawtooth'}, envelope:{attack:.01,decay:.5,sustain:0,release:.1}}).toDestination();
      s.triggerAttackRelease('C4','4n'); s.frequency.rampTo('C2',.5);
    }
    function runAcidRain(){
      transitionCanvas.classList.remove('hidden');
      const ctx = transitionCanvas.getContext('2d');
      let w = transitionCanvas.width = window.innerWidth; let h = transitionCanvas.height = window.innerHeight;
      let cols = Math.floor(w/20)+1; let ypos = Array(cols).fill(0);
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
      let anim = setInterval(()=>{ ctx.fillStyle='#0001'; ctx.fillRect(0,0,w,h); ctx.fillStyle='#4ade80'; ctx.font='15pt monospace'; ypos.forEach((y,i)=>{ const x=i*20; ctx.fillText(String.fromCharCode(Math.random()*128),x,y); ypos[i]= y>100+Math.random()*1e4?0:y+20; }); },50);
      setTimeout(()=>{ clearInterval(anim); let o=1; const f=setInterval(()=>{ ctx.fillStyle=`rgba(0,0,0,${o*.1})`; ctx.fillRect(0,0,w,h); o-=.1; if(o<=0){clearInterval(f); transitionCanvas.classList.add('hidden');}},50); },2000);
    }
    window.addEventListener('keydown',(e)=>{ if(e.key===konamiCode[konamiIndex]){ konamiIndex++; if(konamiIndex===konamiCode.length){ const isRetro=document.body.classList.toggle('retro-mode'); if(isRetro){ runAcidRain(); playRetroMusic(); } else { playPowerDownSound(); } konamiIndex=0; } } else { konamiIndex=0; } });
    let hornClickCount=0; let hornTimeout; mainTitle.addEventListener('click', async()=>{ clearTimeout(hornTimeout); hornClickCount++; if(hornClickCount===5){ await Tone.start(); const horn=new Tone.Oscillator(185,'sawtooth').toDestination(); horn.volume.value=-12; horn.start().stop('+0.8'); hornClickCount=0; } hornTimeout=setTimeout(()=>{hornClickCount=0;},2000); });

    // ====== Theme toggle ======
    const themeToggleBtn=document.getElementById('theme-toggle');
    const themeToggleDarkIcon=document.getElementById('theme-toggle-dark-icon');
    const themeToggleLightIcon=document.getElementById('theme-toggle-light-icon');
    function updateThemeIcon(isDark){ themeToggleDarkIcon.classList.toggle('hidden',!isDark); themeToggleLightIcon.classList.toggle('hidden',isDark); }
    themeToggleBtn.addEventListener('click',()=>{ document.documentElement.classList.toggle('dark'); const isDark=document.documentElement.classList.contains('dark'); localStorage.setItem('theme', isDark?'dark':'light'); updateThemeIcon(isDark); });

    // ====== Menu ======
    function openMenu(){ sideMenu.classList.remove('-translate-x-full'); menuOverlay.classList.remove('hidden'); }
    function closeMenu(){ sideMenu.classList.add('-translate-x-full'); menuOverlay.classList.add('hidden'); mainMenu.classList.remove('hidden'); historyView.classList.add('hidden'); feedbackView.classList.add('hidden'); samplesView.classList.add('hidden'); }
    openMenuBtn.addEventListener('click', openMenu); closeMenuBtn.addEventListener('click',closeMenu); menuOverlay.addEventListener('click',closeMenu);
    historyMenuBtn.addEventListener('click',(e)=>{ e.preventDefault(); mainMenu.classList.add('hidden'); historyView.classList.remove('hidden'); renderHistory(); });
    feedbackMenuBtn.addEventListener('click',(e)=>{ e.preventDefault(); mainMenu.classList.add('hidden'); feedbackView.classList.remove('hidden'); });
    samplesMenuBtn.addEventListener('click',(e)=>{ e.preventDefault(); mainMenu.classList.add('hidden'); samplesView.classList.remove('hidden'); });
    backToMenuHist.addEventListener('click',()=>{ historyView.classList.add('hidden'); mainMenu.classList.remove('hidden'); });
    backToMenuFeed.addEventListener('click',()=>{ feedbackView.classList.add('hidden'); mainMenu.classList.remove('hidden'); });
    backToMenuSamples.addEventListener('click',()=>{ samplesView.classList.add('hidden'); mainMenu.classList.remove('hidden'); });

    // ====== Samples (Test Cases) ======
    samplesView.querySelectorAll('button[data-sample]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const {a,b,c}=JSON.parse(btn.dataset.sample);
        leg1Origin.value=a; leg1Dest.value=b; leg2Dest.value=c; fetchAndApplyMiles(); closeMenu();
      });
    });

    // ====== History ======
    function updatePersonalCounterDisplay(){ personalCalcCounter.textContent = personalCalcCount.toLocaleString(); }
    function saveCalculation(){
      const pInput = parseFloat(primaryInput.value)||0; const miles = parseFloat(milesInput.value)||0;
      if(pInput>0 && miles>0){
        const calculation = { mode: currentMode, primaryInput: primaryInput.value, miles: milesInput.value, tonnage: tonnageInput.value, fsc: fscInput.value, a: leg1Origin.value, b: leg1Dest.value, c: leg2Dest.value, timestamp: new Date().toISOString() };
        if(calculationHistory.length>0){ const last=calculationHistory[0]; if(JSON.stringify(last)===JSON.stringify(calculation)) return; }
        calculationHistory.unshift(calculation); calculationHistory = calculationHistory.slice(0,10);
        localStorage.setItem('thompsonCalcHistory', JSON.stringify(calculationHistory));
        personalCalcCount++; localStorage.setItem('thompsonPersonalCalcCount', personalCalcCount); updatePersonalCounterDisplay();
      }
    }
    function getSummaryText(calc=null){
      const data = calc || { mode: currentMode, primaryInput: primaryInput.value, miles: milesInput.value, tonnage: tonnageInput.value, fsc: fscInput.value };
      const pInput = parseFloat(data.primaryInput)||0; const miles=parseFloat(data.miles)||0; const tonnage=parseFloat(data.tonnage)||23; const fscPercent=parseFloat(data.fsc)||0;
      let lineHaul=0, pOutput=0;
      switch(data.mode){
        case 'generateQuote': lineHaul = pInput * miles; break;
        case 'calculateFromTon': lineHaul = pInput * tonnage; break;
        case 'calculateFromFlat': lineHaul = pInput; break;
      }
      const total = lineHaul * (1 + fscPercent / 100);
      switch(data.mode){
        case 'generateQuote': pOutput = total>0 ? total/tonnage : 0; break;
        case 'calculateFromTon':
        case 'calculateFromFlat': pOutput = miles>0 ? total/miles : 0; break;
      }
      let yourRateLabel, yourRateValue, offerLabel, offerValue;
      if(data.mode==='generateQuote'){
        yourRateLabel='Your Rate:'; yourRateValue=`$${pInput.toFixed(2)} / mile`; offerLabel='Quote to Customer:'; offerValue=`$${pOutput.toFixed(2)} / ton`;
      } else {
        yourRateLabel='Your Calculated Rate:'; yourRateValue=`$${pOutput.toFixed(2)} / mile`; offerLabel='Customer Offer:'; offerValue = data.mode==='calculateFromTon' ? `$${pInput.toFixed(2)} / ton` : `$${pInput.toFixed(2)} (Flat)`;
      }
      return {yourRateLabel,yourRateValue,offerLabel,offerValue};
    }
    function renderHistory(){
      historyList.innerHTML='';
      if(calculationHistory.length===0){ historyList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No recent calculations.</p>`; return; }
      calculationHistory.forEach((calc,idx)=>{
        const {yourRateValue,offerValue} = getSummaryText(calc);
        const button=document.createElement('button');
        button.className='w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700';
        const modePretty = calc.mode==='generateQuote'?'Generate Quote': calc.mode==='calculateFromTon'?'Calc from Ton':'Calc from Flat';
        button.innerHTML = `<div class='font-bold text-gray-800 dark:text-gray-200'>${modePretty} — ${new Date(calc.timestamp).toLocaleString()}</div><div class='text-sm text-gray-600 dark:text-gray-400'>Stops: ${calc.a} → ${calc.b} → ${calc.c} • Miles: ${calc.miles} • ${yourRateValue} | ${offerValue}</div>`;
        button.onclick=()=>{ loadFromHistory(idx); closeMenu(); };
        historyList.appendChild(button);
      });
    }
    function loadFromHistory(idx){
      const calc = calculationHistory[idx];
      setMode(calc.mode);
      primaryInput.value = calc.primaryInput;
      milesInput.value = calc.miles;
      tonnageInput.value = calc.tonnage || 23;
      fscInput.value = calc.fsc;
      leg1Origin.value = calc.a||''; leg1Dest.value=calc.b||''; leg2Dest.value=calc.c||'';
      calculate();
    }
    clearHistoryBtn.addEventListener('click',()=>{ calculationHistory=[]; localStorage.removeItem('thompsonCalcHistory'); renderHistory(); });

    // ====== Feedback ======
    feedbackForm.addEventListener('submit',(e)=>{
      e.preventDefault(); const message=document.getElementById('feedback-message').value;
      if(message.trim()){
        const recipient='mgardner@thompsontrans.net';
        const subject='Feedback for Freight Calculator';
        const body=encodeURIComponent(message);
        window.location.href=`mailto:${recipient}?subject=${encodeURIComponent(subject)}&body=${body}`;
        feedbackForm.innerHTML = `<p class='text-center text-lg text-green-600 dark:text-green-400'>Openin
