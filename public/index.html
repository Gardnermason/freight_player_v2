<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thompson Transportation Freight Calculator â€“ v3.1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Caveat:wght@700&family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&family=Roboto:wght@400;500;700&family=Press+Start+2P&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Trimble Maps JS SDK (for the interactive map) -->
    <link href="https://maps-sdk.trimblemaps.com/v4/trimblemaps-4.2.3.css" rel="stylesheet" />
    <script src="https://maps-sdk.trimblemaps.com/v4/trimblemaps-4.2.3.js" defer></script>

    <script>
        // Apply dark mode immediately from localStorage to prevent flashing
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        /* --- Base and Theming Styles --- */
        @keyframes vaporwave {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: vaporwave 15s ease infinite;
            transition: background-color 0.3s ease;
        }
        .dark body {
            background: #1f2937;
            animation: none;
        }
        #calculator-ui { background-color: #e0e0d8; }
        .dark #calculator-ui { background-color: #374151; }

        #map-container { background-color: #9bbc0f; border-color: #4b5563; }
        .dark #map-container { background-color: #1f2937; border-color: #4b5563; }

        .main-title { font-family: 'Press Start 2P', cursive; cursor: pointer; }

        .gb-text { color: #1f2937; }
        .dark .gb-text { color: #e5e7eb; }

        .dynamic-label { transition: opacity 0.3s ease-in-out; }

        /* --- Form and Input Styles --- */
        .form-input:focus { outline: none; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5); border-color: #3b82f6 !important; }
        .editable-field { background-color: #e0e0d8; color: #111827; border-color: #4b5563; }
        .dark .editable-field { background-color: #374151; color: white; border-color: #4b5563; }
        .output-field { background-color: #c8c8c0; font-weight: bold; border-color: #4b5563; }
        .dark .output-field { background-color: #1f2937; color: #e5e7eb; border-color: #4b5563; }

        /* --- Side Menu --- */
        #side-menu { transition: transform 0.3s ease-in-out; }

        /* --- Controller UI Styles (D-Pad, AB Buttons) --- */
        .d-pad { display: grid; grid-template-columns: 1fr 1fr 1fr; width: 100px; height: 100px; }
        .d-pad-btn { background-color: #1f2937; transition: background-color 0.2s; }
        .dark .d-pad-btn { background-color: #4b5563; }
        .d-pad-btn:active { background-color: #4b5563; }
        .dark .d-pad-btn:active { background-color: #5a6678; }
        .up { grid-column: 2; grid-row: 1; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);}
        .left { grid-column: 1; grid-row: 2; clip-path: polygon(0% 50%, 50% 100%, 100% 50%, 50% 0%);}
        .center { grid-column: 2; grid-row: 2; }
        .right { grid-column: 3; grid-row: 2; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);}
        .down { grid-column: 2; grid-row: 3; clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);}

        .ab-buttons { display: flex; align-items: center; gap: 0.75rem; }
        .ab-btn {
            width: 45px; height: 45px; border-radius: 50%;
            background-color: #ab2946;
            color: white; font-family: 'Bungee', sans-serif;
            text-align: center; line-height: 45px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: background-color 0.2s; font-size: 1.1rem;
        }
        .dark .ab-btn { background-color: #7e22ce; }
        .ab-btn:active { background-color: #c94a69; }
        .dark .ab-btn:active { background-color: #9333ea; }

        /* --- Action Buttons (Email, Print, etc.) --- */
        .action-btn {
            display: inline-flex; align-items: center; justify-content: center;
            gap: 0.5rem; padding: 0.375rem 0.75rem; border-radius: 9999px;
            font-weight: bold; color: #f3f4f6; background-color: #4b5563;
            border: 2px solid #1f2937; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.2s ease-in-out;
        }
        .dark .action-btn { color: #4b5563; background-color: #9ca3af; border: 2px solid #4b5563; }
        .action-btn:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* --- Mode Selector (Quote, Ton, Flat) --- */
        #mode-selector-container { background-color: transparent; }
        .mode-btn { color: #1f2937; transition: color 0.3s ease-in-out; z-index: 10; font-family: 'Press Start 2P', cursive; font-size: 0.6rem; }
        .dark .mode-btn { color: #9ca3af; }
        .mode-btn.active { color: #111827; }
        .dark .mode-btn.active { color: #f9fafb; }
        #mode-slider { background-color: #9ca3af; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 5; border-radius: 9999px; }
        .dark #mode-slider { background-color: #4b5563; }

        /* --- Spinner for Loading States --- */
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- RETRO MODE STYLES --- */
        .retro-mode body {
            background-image: none !important; background-color: #000 !important;
            font-family: 'Press Start 2P', cursive !important;
        }
        .retro-mode #calculator-ui {
            background: #000 !important; border: 4px solid #4ade80 !important;
            box-shadow: none !important; border-radius: 0 !important;
        }
        .retro-mode .main-title, .retro-mode .font-bold, .retro-mode .gb-text, .retro-mode .mode-btn, .dark.retro-mode .mode-btn {
            color: #4ade80 !important; text-shadow: 2px 2px #000;
        }
        .retro-mode .mode-btn.active { color: #000 !important; }
        .retro-mode .form-input, .retro-mode .d-pad-btn, .retro-mode .ab-btn, .retro-mode .action-btn {
            border-radius: 0 !important; border: 2px solid #4ade80 !important;
            background: #000 !important; color: #4ade80 !important;
        }
        .retro-mode .ab-btn, .retro-mode .action-btn:active { background: #4ade80 !important; color: #000 !important; }
        .retro-mode .d-pad-btn { background: #000 !important; border-color: #4ade80 !important; }
        .retro-mode #mode-slider { background-color: #4ade80 !important; }
        .retro-mode hr { border-color: #4ade80 !important; }

        /* --- FINAL PRINT STYLES --- */
        @media print {
            body, html { background: white !important; }
            #calculator-ui, #side-menu, #menu-overlay, .controls-container { display: none !important; }
            .print-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
            .print-area-content { background-color: white !important; color: black !important; -webkit-print-color-adjust: exact; color-adjust: exact; }
            .print-area-content * { color: black !important; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 overflow-x-hidden dark:bg-gray-900">

    <!-- Transition Canvas for Retro Mode -->
    <canvas id="transition-canvas" class="fixed inset-0 w-full h-full z-50 pointer-events-none hidden"></canvas>

    <!-- Menu Overlay -->
    <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"></div>

    <!-- Side Menu -->
    <div id="side-menu" class="fixed top-0 left-0 h-full w-80 bg-white dark:bg-gray-800 shadow-xl z-40 transform -translate-x-full">
        <div class="p-5 flex flex-col h-full">
            <div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-[#003366] dark:text-blue-200">Menu</h2>
                    <button id="close-menu-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <nav id="main-menu" class="space-y-2">
                    <!-- Server key (kept private on your backend) -->
                    <div class="p-3">
                        <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Routing API Key (server)</label>
                        <input type="password" id="apiKeyInput" placeholder="Saved in browser for dev only" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-sm">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">For production, set <code>TRIMBLE_API_KEY</code> on the server. This field is optional for local tests.</p>
                    </div>
                    <!-- Browser key for interactive map -->
                    <div class="p-3">
                        <label for="mapsJsKeyInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Maps JS Key (browser)</label>
                        <input type="text" id="mapsJsKeyInput" placeholder="Used only to render the map" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-sm">
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Best practice: domainâ€‘restrict this key in Trimble console.</p>
                    </div>
                    <a href="#" id="history-menu-btn" class="flex items-center p-3 text-lg text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Recent Calculations
                    </a>
                    <a href="#" id="theme-toggle" class="flex items-center p-3 text-lg text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <svg id="theme-toggle-dark-icon" class="hidden w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                        <svg id="theme-toggle-light-icon" class="hidden w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 10.607a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414l-.707.707a1 1 0 01-1.414 0zM3 11a1 1 0 100-2H2a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                        Night Shift
                    </a>
                    <a href="#" id="feedback-menu-btn" class="flex items-center p-3 text-lg text-gray-700 dark:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                        Send Feedback
                    </a>
                </nav>
            </div>
            <!-- Spacer -->
            <div class="flex-grow"></div>
            <!-- Personal Stats & Version -->
            <div class="mt-auto p-4 border-t border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-center text-[#003366] dark:text-blue-200">Calculation Counter</h3>
                <p id="personal-calc-counter" class="text-4xl font-bold text-center text-blue-600 dark:text-blue-400 mt-2">0</p>
                <p class="text-center text-xs text-gray-400 dark:text-gray-500 mt-2">Version 3.1.1</p>
            </div>
            <!-- History View -->
            <div id="history-view" class="hidden absolute inset-0 bg-white dark:bg-gray-800 p-5">
                <div class="flex justify-between items-center mb-4">
                    <button id="back-to-menu-hist" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h3 class="text-xl font-bold text-center text-[#003366] dark:text-blue-200">History</h3>
                    <div class="w-6"></div>
                </div>
                <div id="history-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                <button id="clear-history-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Clear History</button>
            </div>
            <!-- Feedback View -->
            <div id="feedback-view" class="hidden absolute inset-0 bg-white dark:bg-gray-800 p-5">
                <div class="flex justify-between items-center mb-4">
                    <button id="back-to-menu-feed" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <svg class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <h3 class="text-xl font-bold text-center text-[#003366] dark:text-blue-200">Feedback</h3>
                    <div class="w-6"></div>
                </div>
                <form id="feedback-form" class="space-y-4">
                    <textarea id="feedback-message" placeholder="Your feedback..." rows="5" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700"></textarea>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Send</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Calculator UI -->
    <div id="calculator-ui" class="w-full max-w-sm mx-auto p-4 rounded-2xl shadow-2xl border-4 border-gray-400 dark:border-gray-500">
        <div class="flex justify-between items-center">
            <button id="open-menu-btn" type="button" class="p-1 gb-text rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 id="main-title" class="main-title text-center text-sm gb-text">Thompson Transportation</h1>
            <div class="w-6"></div>
        </div>

        <!-- Screen Area -->
        <div id="map-container" class="my-2 rounded-lg aspect-square flex items-center justify-center">
            <img id="map-image" src="" alt="Route map" class="object-contain h-full w-full rounded-lg hidden">
            <div id="map-loader" class="spinner hidden"></div>
            <span id="map-placeholder" class="gb-text">Route map will be displayed here</span>
        </div>

        <form id="rateCalculatorForm" onsubmit="return false;">
            <!-- Mode Selector -->
            <div id="mode-selector-container" class="relative grid grid-cols-3 gap-2 mb-3 p-1 rounded-full">
                <div id="mode-slider" class="absolute top-1 bottom-1 left-1 w-1/3 rounded-full"></div>
                <button type="button" data-mode="generateQuote" class="mode-btn py-1 px-1 rounded-full">Quote</button>
                <button type="button" data-mode="calculateFromTon" class="mode-btn py-1 px-1 rounded-full">Ton</button>
                <button type="button" data-mode="calculateFromFlat" class="mode-btn py-1 px-1 rounded-full">Flat</button>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- Left Side: Locations / Manual Miles -->
                <div id="pcmiler-inputs" class="space-y-1 hidden">
                    <input type="text" id="stop1" placeholder="Origin" class="form-input editable-field w-full p-1.5 text-sm font-semibold border-2 rounded-lg shadow-inner">
                    <input type="text" id="stop2" placeholder="P/U Location" class="form-input editable-field w-full p-1.5 text-sm font-semibold border-2 rounded-lg shadow-inner">
                    <input type="text" id="stop3" placeholder "Del. Location" class="form-input editable-field w-full p-1.5 text-sm font-semibold border-2 rounded-lg shadow-inner">
                    <div class="flex items-center justify-between pt-1">
                        <label class="font-bold text-sm gb-text">Total Miles</label>
                        <input type="number" id="total-miles-output" readonly class="form-input output-field w-24 p-1.5 text-sm text-right font-semibold border-2 rounded-lg shadow-inner">
                    </div>
                </div>
                <div id="manual-miles-input" class="space-y-1">
                    <div class="flex items-center justify-between">
                        <label class="font-bold text-sm gb-text">Total Miles</label>
                        <input type="number" id="miles" class="form-input editable-field w-24 p-1.5 text-sm text-right font-semibold border-2 rounded-lg shadow-inner">
                    </div>
                </div>

                <!-- Right Side: Calculations -->
                <div id="right-column" class="space-y-1 flex flex-col">
                    <div id="field-primary-input" class="flex items-center justify-between">
                        <label class="font-bold text-sm gb-text dynamic-label" id="primary-input-label">($/Mile)</label>
                        <input type="number" step="0.01" id="primary-input" class="form-input editable-field w-24 p-1.5 text-sm text-right font-semibold border-2 rounded-lg shadow-inner">
                    </div>
                    <div id="field-tonnage" class="flex items-center justify-between">
                        <label class="font-bold text-sm gb-text">Tonnage</label>
                        <input type="number" id="tonnage" value="23" class="form-input editable-field w-24 p-1.5 text-sm text-right font-semibold border-2 rounded-lg shadow-inner">
                    </div>
                    <div id="field-fsc" class="flex items-center justify-between">
                        <label class="font-bold text-sm gb-text">FSC (%)</label>
                        <input type="number" id="fsc" class="form-input editable-field w-24 p-1.5 text-sm text-right font-semibold border-2 rounded-lg shadow-inner">
                    </div>
                    <hr id="field-hr" class="border-gray-600 dark:border-gray-500 my-1">
                    <div id="field-primary-output" class="flex items-center justify-between">
                        <label class="font-bold text-sm gb-text dynamic-label" id="primary-output-label">($/Ton)</label>
                        <input type="text" id="primary-output" readonly class="form-input output-field w-24 p-1.5 text-sm text-right font-semibold border-2 rounded-lg shadow-inner cursor-not-allowed">
                    </div>
                    <div id="field-fsc-total" class="flex items-center justify-between">
                        <label class="font-bold text-sm gb-text">FSC Total</label>
                        <input type="text" id="fsc-total" readonly class="form-input output-field w-24 p-1.5 text-sm text-right font-semibold border-2 rounded-lg shadow-inner cursor-not-allowed">
                    </div>
                    <div id="field-final-total" class="flex items-center justify-between">
                        <label class="font-bold text-sm gb-text">Final Total</label>
                        <input type="text" id="final-total" readonly class="form-input output-field w-24 p-1.5 text-sm text-right font-semibold border-2 rounded-lg shadow-inner cursor-not-allowed">
                    </div>
                </div>
            </div>
            <div class="mt-3 controls-container">
                <div class="flex items-center justify-between">
                    <div class="d-pad">
                        <button type="button" data-key="ArrowUp" class="d-pad-btn up"></button>
                        <button type="button" data-key="ArrowLeft" class="d-pad-btn left"></button>
                        <div class="d-pad-btn center"></div>
                        <button type="button" data-key="ArrowRight" class="d-pad-btn right"></button>
                        <button type="button" data-key="ArrowDown" class="d-pad-btn down"></button>
                    </div>
                    <div class="ab-buttons">
                        <button type="button" data-key="b" class="ab-btn">B</button>
                        <button type="button" data-key="a" id="calculateRouteBtn" class="ab-btn">A</button>
                    </div>
                </div>
                <div class="flex justify-center space-x-2 mt-2">
                    <button type="button" id="emailButton" class="action-btn btn-email text-xs">Email</button>
                    <button type="button" id="printButton" class="action-btn btn-print text-xs hidden">Print</button>
                    <button type="button" id="copyButton" class="action-btn btn-copy text-xs">Copy</button>
                    <button type="button" id="resetButton" class="action-btn btn-reset text-xs">Reset</button>
                </div>
            </div>
            <p id="api-error" class="text-red-800 text-sm text-center mt-2 hidden"></p>
            <div id="copyNotification" class="text-center text-green-700 dark:text-green-400 font-semibold mt-2 h-6 opacity-0 transition-opacity duration-300"></div>
            <button type="button" id="manual-mode-btn" class="text-xs gb-text hover:underline text-center w-full mt-2">Switch to Route Planner</button>
        </form>
    </div>

    <!-- Printable Area -->
    <div class="print-area hidden">
        <div class="print-area-content p-8">
            <h1 class="text-2xl font-bold mb-2">Thompson Transportation</h1>
            <h2 class="text-xl font-semibold mb-6 border-b pb-2">Freight Calculation Summary</h2>
            <p class="mb-2 text-lg"><strong class="w-48 inline-block">Date:</strong> <span id="print-date"></span></p>
            <p class="mb-2 text-lg"><strong class="w-48 inline-block">Calculation Mode:</strong> <span id="print-mode"></span></p>
            <div id="print-locations" class="hidden">
                <p class="mb-2 text-lg"><strong class="w-48 inline-block">Origin:</strong> <span id="print-origin"></span></p>
                <p class="mb-2 text-lg"><strong class="w-48 inline-block">P/U Location:</strong> <span id="print-pickup"></span></p>
                <p class="mb-2 text-lg"><strong class="w-48 inline-block">Del. Location:</strong> <span id="print-delivery"></span></p>
            </div>
            <p class="mb-2 text-lg"><strong class="w-48 inline-block">Total Miles:</strong> <span id="print-miles"></span></p>
            <p class="mb-2 text-lg"><strong class="w-48 inline-block">Tonnage:</strong> <span id="print-tonnage"></span></p>
            <p class="mb-2 text-lg"><strong class="w-48 inline-block">FSC (%):</strong> <span id="print-fsc"></span></p>
            <hr class="my-4">
            <p class="mb-2 text-lg" id="print-your-rate-row"><strong class="w-48 inline-block"></strong> <span id="print-your-rate"></span></p>
            <p class="mb-2 text-lg" id="print-offer-row"><strong class "w-48 inline-block"></strong> <span id "print-offer"></span></p>
            <hr class="my-4">
            <p class="mb-2 text-lg"><strong class="w-48 inline-block">FSC Total:</strong> <span id="print-fsc-total"></span></p>
            <p class="text-xl font-bold mt-4"><strong class="w-48 inline-block">Final Total:</strong> <span id="print-final-total"></span></p>
        </div>
    </div>

    <textarea id="copySource" class="sr-only"></textarea>

    <script>
        // --- DOM Element Selection ---
        const form = document.getElementById('rateCalculatorForm');
        const primaryInput = document.getElementById('primary-input');
        const primaryInputLabel = document.getElementById('primary-input-label');
        const primaryOutputLabel = document.getElementById('primary-output-label');
        const milesInput = document.getElementById('miles');
        const tonnageInput = document.getElementById('tonnage');
        const fscInput = document.getElementById('fsc');
        const primaryOutput = document.getElementById('primary-output');
        const fscTotal = document.getElementById('fsc-total');
        const finalTotal = document.getElementById('final-total');
        const copyButton = document.getElementById('copyButton');
        const resetButton = document.getElementById('resetButton');
        const printButton = document.getElementById('printButton');
        const emailButton = document.getElementById('emailButton');
        const copyNotification = document.getElementById('copyNotification');
        const copySource = document.getElementById('copySource');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        const transitionCanvas = document.getElementById('transition-canvas');
        const mainTitle = document.getElementById('main-title');
        const openMenuBtn = document.getElementById('open-menu-btn');
        const closeMenuBtn = document.getElementById('close-menu-btn');
        const sideMenu = document.getElementById('side-menu');
        const menuOverlay = document.getElementById('menu-overlay');
        const mainMenu = document.getElementById('main-menu');
        const historyView = document.getElementById('history-view');
        const feedbackView = document.getElementById('feedback-view');
        const historyMenuBtn = document.getElementById('history-menu-btn');
        const feedbackMenuBtn = document.getElementById('feedback-menu-btn');
        const backToMenuHist = document.getElementById('back-to-menu-hist');
        const backToMenuFeed = document.getElementById('back-to-menu-feed');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const feedbackForm = document.getElementById('feedback-form');
        const personalCalcCounter = document.getElementById('personal-calc-counter');
        const modeSelectorContainer = document.getElementById('mode-selector-container');
        const modeSlider = document.getElementById('mode-slider');
        const modeButtons = Array.from(modeSelectorContainer.querySelectorAll('.mode-btn'));
        const apiKeyInput = document.getElementById('apiKeyInput');
        const mapsJsKeyInput = document.getElementById('mapsJsKeyInput');
        const manualModeBtn = document.getElementById('manual-mode-btn');
        const pcmilerInputs = document.getElementById('pcmiler-inputs');
        const manualMilesInput = document.getElementById('manual-miles-input');
        const totalMilesOutput = document.getElementById('total-miles-output');
        const stop1Input = document.getElementById('stop1');
        const stop2Input = document.getElementById('stop2');
        const stop3Input = document.getElementById('stop3');
        const calculateRouteBtn = document.getElementById('calculateRouteBtn');
        const mapLoader = document.getElementById('map-loader');
        const mapPlaceholder = document.getElementById('map-placeholder');
        const mapImage = document.getElementById('map-image');
        const apiError = document.getElementById('api-error');

        // --- New: Hide server/browser key inputs in production and auto-load map key ---
        const isProd = !location.hostname.includes('localhost');
        const serverKeySection = apiKeyInput.closest('.p-3');
        const mapsKeySection = mapsJsKeyInput.closest('.p-3');
        async function loadPublicConfigIfAny() {
            try {
                const res = await fetch('/api/public-config');
                if (res.ok) {
                    const { mapsKey } = await res.json();
                    if (mapsKey) {
                        mapsJsKeyInput.value = mapsKey;
                        localStorage.setItem('trimbleMapsBrowserKey', mapsKey);
                        // Hide browser key field when loaded from server
                        mapsKeySection.style.display = 'none';
                    }
                }
            } catch {}
            if (isProd) {
                serverKeySection.style.display = 'none';
            }
        }

        // --- State Management ---
        let currentMode = 'generateQuote';
        let calculationHistory = JSON.parse(localStorage.getItem('thompsonCalcHistory_v3')) || [];
        let personalCalcCount = parseInt(localStorage.getItem('thompsonPersonalCalcCount_v3')) || 0;

        // --- Easter Eggs & Special Effects ---
        const konamiCode = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
        let konamiIndex = 0;

        async function playRetroMusic() {
            try {
                await Tone.start();
                const synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: 'square' },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.2, release: 0.1 }
                }).toDestination();
                const now = Tone.now();
                synth.triggerAttackRelease('C#3', '8n', now);
                synth.triggerAttackRelease('G#2', '8n', now + 0.25);
            } catch (e) {
                console.error('Tone.js could not start. User interaction might be required.', e);
            }
        }

        async function playPowerDownSound() {
            try {
                await Tone.start();
                const synth = new Tone.Synth({
                    oscillator: { type: 'sawtooth' },
                    envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.1 }
                }).toDestination();
                synth.triggerAttackRelease('C4', '4n');
                synth.frequency.rampTo('C2', 0.5);
            } catch (e) {
                console.error('Tone.js could not start.', e);
            }
        }

        function runAcidRain() {
            transitionCanvas.classList.remove('hidden');
            const ctx = transitionCanvas.getContext('2d');
            let w = transitionCanvas.width = window.innerWidth;
            let h = transitionCanvas.height = window.innerHeight;
            let cols = Math.floor(w / 20) + 1;
            let ypos = Array(cols).fill(0);
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            let animFrame;
            function matrix() {
                ctx.fillStyle = 'rgba(0,0,0,0.05)';
                ctx.fillRect(0, 0, w, h);
                ctx.fillStyle = '#4ade80';
                ctx.font = '15pt monospace';
                ypos.forEach((y, ind) => {
                    const text = String.fromCharCode(Math.random() * 128);
                    const x = ind * 20;
                    ctx.fillText(text, x, y);
                    if (y > 100 + Math.random() * 10000) ypos[ind] = 0;
                    else ypos[ind] = y + 20;
                });
            }
            animFrame = setInterval(matrix, 50);
            setTimeout(() => {
                clearInterval(animFrame);
                let opacity = 1;
                const fadeOut = setInterval(() => {
                    ctx.fillStyle = `rgba(0,0,0,${opacity * 0.1})`;
                    ctx.fillRect(0, 0, w, h);
                    opacity -= 0.1;
                    if (opacity <= 0) {
                        clearInterval(fadeOut);
                        transitionCanvas.classList.add('hidden');
                    }
                }, 50);
            }, 2000);
        }

        function handleKonami(key) {
            if (key === konamiCode[konamiIndex]) {
                konamiIndex++;
                if (konamiIndex === konamiCode.length) {
                    const isRetro = document.body.classList.toggle('retro-mode');
                    if (isRetro) {
                        runAcidRain();
                        playRetroMusic();
                    } else {
                        playPowerDownSound();
                    }
                    konamiIndex = 0;
                }
            } else {
                konamiIndex = 0;
            }
        }

        let hornClickCount = 0;
        let hornTimeout;
        function handleHornClick() {
            clearTimeout(hornTimeout);
            hornClickCount++;
            if (hornClickCount === 5) {
                try {
                    Tone.start().then(() => {
                        const horn = new Tone.Oscillator(185, 'sawtooth').toDestination();
                        horn.volume.value = -12;
                        horn.start().stop('+0.8');
                    });
                    hornClickCount = 0;
                } catch(e) {
                    console.error('Tone.js could not start.', e);
                }
            }
            hornTimeout = setTimeout(() => { hornClickCount = 0; }, 2000);
        }

        // --- Menu, Theme, History, and Feedback Logic ---
        function openMenu() {
            sideMenu.classList.remove('-translate-x-full');
            menuOverlay.classList.remove('hidden');
        }

        function closeMenu() {
            sideMenu.classList.add('-translate-x-full');
            menuOverlay.classList.add('hidden');
            mainMenu.classList.remove('hidden');
            historyView.classList.add('hidden');
            feedbackView.classList.add('hidden');
        }

        function updateThemeIcon(isDarkMode) {
            themeToggleDarkIcon.classList.toggle('hidden', !isDarkMode);
            themeToggleLightIcon.classList.toggle('hidden', isDarkMode);
        }

        function toggleTheme(e) {
            e.preventDefault();
            document.documentElement.classList.toggle('dark');
            const isDarkMode = document.documentElement.classList.contains('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeIcon(isDarkMode);
        }

        function updatePersonalCounterDisplay() {
            personalCalcCounter.textContent = personalCalcCount.toLocaleString();
        }

        function saveCalculation() {
            const isRoutePlannerMode = !pcmilerInputs.classList.contains('hidden');
            const currentMiles = isRoutePlannerMode ? totalMilesOutput.value : milesInput.value;
            const pInput = parseFloat(primaryInput.value) || 0;
            const miles = parseFloat(currentMiles) || 0;
            if (pInput > 0 && miles > 0) {
                const calculation = { mode: currentMode, primaryInput: primaryInput.value, miles: currentMiles, tonnage: tonnageInput.value, fsc: fscInput.value, timestamp: new Date().toISOString() };
                calculationHistory.unshift(calculation);
                calculationHistory = calculationHistory.slice(0, 10);
                localStorage.setItem('thompsonCalcHistory_v3', JSON.stringify(calculationHistory));
                personalCalcCount++;
                localStorage.setItem('thompsonPersonalCalcCount_v3', personalCalcCount);
                updatePersonalCounterDisplay();
            }
        }

        function renderHistory() {
            historyList.innerHTML = '';
            if (calculationHistory.length === 0) {
                historyList.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No recent calculations.</p>`;
                return;
            }
            calculationHistory.forEach((calc, index) => {
                const { yourRateValue, offerValue, modeLabel } = getSummaryText(calc);
                const button = document.createElement('button');
                button.className = 'w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700';
                button.innerHTML = `<div class="font-bold text-gray-800 dark:text-gray-200">${modeLabel}</div><div class="text-sm text-gray-600 dark:text-gray-400">Rate: ${yourRateValue} | Offer: ${offerValue}</div>`;
                button.onclick = () => { loadFromHistory(index); closeMenu(); };
                historyList.appendChild(button);
            });
        }

        function loadFromHistory(index) {
            const calc = calculationHistory[index];
            setMode(calc.mode);
            primaryInput.value = calc.primaryInput;
            milesInput.value = calc.miles;
            totalMilesOutput.value = calc.miles;
            tonnageInput.value = calc.tonnage || 23;
            fscInput.value = calc.fsc;
            calculate();
        }

        function handleFeedbackSubmit(e) {
            e.preventDefault();
            const message = document.getElementById('feedback-message').value;
            if (message.trim()) {
                window.location.href = `mailto:mgardner@thompsontrans.net?subject=Feedback%20for%20Freight%20Calculator%20v3&body=${encodeURIComponent(message)}`;
            }
        }

        // --- Core Calculator Logic ---
        function setMode(newMode) {
            currentMode = newMode;
            const activeButton = modeButtons.find(btn => btn.dataset.mode === newMode);
            modeButtons.forEach(btn => btn.classList.remove('active'));
            activeButton.classList.add('active');
            const { offsetLeft, offsetWidth } = activeButton;
            modeSlider.style.width = `${offsetWidth}px`;
            modeSlider.style.transform = `translateX(${offsetLeft}px)`;
            emailButton.classList.toggle('hidden', newMode !== 'generateQuote');
            printButton.classList.toggle('hidden', newMode === 'generateQuote');
            const isFlatMode = newMode === 'calculateFromFlat';
            tonnageInput.disabled = isFlatMode;
            tonnageInput.classList.toggle('opacity-50', isFlatMode);
            document.querySelectorAll('.dynamic-label').forEach(label => label.classList.add('opacity-0'));
            setTimeout(() => {
                switch (newMode) {
                    case 'generateQuote':
                        primaryInputLabel.textContent = '($/Mile)';
                        primaryOutputLabel.textContent = '($/Ton)';
                        break;
                    case 'calculateFromTon':
                        primaryInputLabel.textContent = '($/Ton)';
                        primaryOutputLabel.textContent = '($/Mile)';
                        break;
                    case 'calculateFromFlat':
                        primaryInputLabel.textContent = 'Flat Rate ($)';
                        primaryOutputLabel.textContent = '($/Mile)';
                        break;
                }
                document.querySelectorAll('.dynamic-label').forEach(label => label.classList.remove('opacity-0'));
            }, 150);
            resetCalculator();
        }

        function calculate() {
            const isRoutePlannerMode = !pcmilerInputs.classList.contains('hidden');
            const currentMiles = isRoutePlannerMode ? totalMilesOutput.value : milesInput.value;
            const pInput = parseFloat(primaryInput.value) || 0;
            const miles = parseFloat(currentMiles) || 0;
            const tonnage = parseFloat(tonnageInput.value) || (currentMode === 'calculateFromFlat' ? 0 : 23);
            const fscPercent = parseFloat(fscInput.value) || 0;
            let lineHaul = 0, pOutput = 0;
            switch (currentMode) {
                case 'generateQuote': lineHaul = pInput * miles; break;
                case 'calculateFromTon': lineHaul = pInput * tonnage; break;
                case 'calculateFromFlat': lineHaul = pInput; break;
            }
            const fscAmount = lineHaul * (fscPercent / 100);
            const total = lineHaul + fscAmount;
            switch (currentMode) {
                case 'generateQuote': pOutput = total > 0 && tonnage > 0 ? total / tonnage : 0; break;
                case 'calculateFromTon':
                case 'calculateFromFlat': pOutput = total > 0 && miles > 0 ? total / miles : 0; break;
            }
            animateValue(primaryOutput, pOutput);
            animateValue(fscTotal, fscAmount);
            animateValue(finalTotal, total);
        }

        function animateValue(element, end) {
            let start = parseFloat(element.value.replace(/[^0-9.-]+/g,"")) || 0;
            if (Math.abs(start - end) < 0.01) {
                element.value = end > 0.005 ? end.toFixed(2) : '';
                return;
            }
            let startTimestamp = null;
            const duration = 300;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentValue = progress * (end - start) + start;
                element.value = currentValue > 0.005 ? currentValue.toFixed(2) : '';
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                } else {
                    element.value = end.toFixed(2);
                }
            };
            window.requestAnimationFrame(step);
        }

        function getSummaryText(calcData = null) {
            const isRoutePlannerMode = !pcmilerInputs.classList.contains('hidden');
            const currentMiles = isRoutePlannerMode ? totalMilesOutput.value : milesInput.value;
            const data = calcData || { mode: currentMode, primaryInput: primaryInput.value, miles: currentMiles, tonnage: tonnageInput.value, fsc: fscInput.value };
            const pInput = parseFloat(data.primaryInput) || 0;
            const miles = parseFloat(data.miles) || 0;
            const tonnage = parseFloat(data.tonnage) || 23;
            const fscPercent = parseFloat(data.fsc) || 0;
            let lineHaul = 0, pOutput = 0;
            switch (data.mode) {
                case 'generateQuote': lineHaul = pInput * miles; break;
                case 'calculateFromTon': lineHaul = pInput * tonnage; break;
                case 'calculateFromFlat': lineHaul = pInput; break;
            }
            const fscAmount = lineHaul * (fscPercent / 100);
            const total = lineHaul + fscAmount;
            switch (data.mode) {
                case 'generateQuote': pOutput = total > 0 && tonnage > 0 ? total / tonnage : 0; break;
                case 'calculateFromTon':
                case 'calculateFromFlat': pOutput = miles > 0 ? total / miles : 0; break;
            }
            let yourRateLabel, yourRateValue, offerLabel, offerValue, modeLabel;
            if (data.mode === 'generateQuote') {
                modeLabel = 'Generate Quote';
                yourRateLabel = 'Your Rate:';
                yourRateValue = `$${pInput.toFixed(2)} / mile`;
                offerLabel = 'Quote to Customer:';
                offerValue = `$${pOutput.toFixed(2)} / ton`;
            } else {
                yourRateLabel = 'Your Calculated Rate:';
                yourRateValue = `$${pOutput.toFixed(2)} / mile`;
                offerLabel = 'Customer Offer:';
                if (data.mode === 'calculateFromTon') {
                    modeLabel = 'Calc from Ton';
                    offerValue = `$${pInput.toFixed(2)} / ton`;
                } else {
                    modeLabel = 'Calc from Flat';
                    offerValue = `$${pInput.toFixed(2)} (Flat)`;
                }
            }
            return { yourRateLabel, yourRateValue, offerLabel, offerValue, modeLabel, fscTotal: fscAmount.toFixed(2), finalTotal: total.toFixed(2) };
        }

        function resetCalculator() {
            form.reset();
            tonnageInput.value = (currentMode === 'calculateFromFlat') ? '' : 23;
            mapImage.classList.add('hidden');
            mapPlaceholder.classList.remove('hidden');
            calculate();
        }

        // --- PC*Miler API Logic (Route Planner & static map fallback) ---
        async function getRouteMiles() {
            const stops = [stop1Input.value, stop2Input.value, stop3Input.value].map(s => s.trim()).filter(Boolean);
            if (stops.length < 2) {
                apiError.textContent = 'Please enter at least two locations.';
                apiError.classList.remove('hidden');
                return;
            }

            mapLoader.classList.remove('hidden');
            mapPlaceholder.classList.add('hidden');
            mapImage.classList.add('hidden');
            apiError.classList.add('hidden');

            try {
                const r = await fetch('/api/route-miles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ locations: stops })
                });
                const json = await r.json();
                if (!r.ok || !json.ok) {
                    throw new Error(json.error || 'Mileage lookup failed');
                }
                totalMilesOutput.value = json.miles.toFixed(1);
                calculate();
                if (json.staticMapUrl) {
                    mapImage.src = json.staticMapUrl;
                    mapImage.classList.remove('hidden');
                } else {
                    mapPlaceholder.classList.remove('hidden');
                }
            } catch (err) {
                apiError.textContent = `Error: ${err.message}`;
                apiError.classList.remove('hidden');
                mapPlaceholder.classList.remove('hidden');
            } finally {
                mapLoader.classList.add('hidden');
            }
        }

        // --- Initial Setup & Event Listeners ---
        async function initialSetup() {
            await loadPublicConfigIfAny();
            // Load API key from local storage
            apiKeyInput.value = localStorage.getItem('pcmilerApiKey') || '';
            // Check which mode (manual/route) to display based on key
            checkApiOrManual();
            // Update the calculation counter display
            updatePersonalCounterDisplay();
            // Set the initial theme based on user preference or system settings
            const savedTheme = localStorage.getItem('theme');
            const isDarkMode = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDarkMode) document.documentElement.classList.add('dark');
            updateThemeIcon(isDarkMode);
            // Set the initial calculation mode to 'Generate Quote'
            setMode('generateQuote');

            // Attach all event listeners
            openMenuBtn.addEventListener('click', openMenu);
            closeMenuBtn.addEventListener('click', closeMenu);
            menuOverlay.addEventListener('click', closeMenu);
            historyMenuBtn.addEventListener('click', (e) => { e.preventDefault(); mainMenu.classList.add('hidden'); historyView.classList.remove('hidden'); renderHistory(); });
            feedbackMenuBtn.addEventListener('click', (e) => { e.preventDefault(); mainMenu.classList.add('hidden'); feedbackView.classList.remove('hidden'); });
            backToMenuHist.addEventListener('click', () => { historyView.classList.add('hidden'); mainMenu.classList.remove('hidden'); });
            backToMenuFeed.addEventListener('click', () => { feedbackView.classList.add('hidden'); mainMenu.classList.remove('hidden'); });
            themeToggleBtn.addEventListener('click', toggleTheme);
            clearHistoryBtn.addEventListener('click', () => { calculationHistory = []; localStorage.removeItem('thompsonCalcHistory_v3'); renderHistory(); });
            feedbackForm.addEventListener('submit', handleFeedbackSubmit);
            resetButton.addEventListener('click', resetCalculator);
            document.querySelector('.ab-btn[data-key="b"]').addEventListener('click', (e) => { e.preventDefault(); resetCalculator(); });
            mainTitle.addEventListener('click', handleHornClick);
            window.addEventListener('keydown', (e) => handleKonami(e.key));
            document.querySelectorAll('.d-pad-btn, .ab-btn').forEach(btn => { btn.addEventListener('click', () => handleKonami(btn.dataset.key)); });
            modeButtons.forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); setMode(button.dataset.mode); }); });
            [primaryInput, milesInput, tonnageInput, fscInput, totalMilesOutput].forEach(input => input.addEventListener('input', calculate));
            let saveTimeout;
            form.addEventListener('input', () => { clearTimeout(saveTimeout); saveTimeout = setTimeout(saveCalculation, 1500); });
            copyButton.addEventListener('click', handleCopy);
            emailButton.addEventListener('click', handleEmail);
            printButton.addEventListener('click', handlePrint);
            calculateRouteBtn.addEventListener('click', (e) => { e.preventDefault(); if (!pcmilerInputs.classList.contains('hidden')) { getRouteMiles(); } });
            apiKeyInput.addEventListener('input', () => { localStorage.setItem('pcmilerApiKey', apiKeyInput.value); checkApiOrManual(); });
            manualModeBtn.addEventListener('click', () => { pcmilerInputs.classList.toggle('hidden'); manualMilesInput.classList.toggle('hidden'); checkApiOrManual(); });
        }

        function checkApiOrManual() {
            const hasKey = apiKeyInput.value.trim().length > 0;
            const manualIsHidden = manualMilesInput.classList.contains('hidden');
            if (hasKey && manualIsHidden) {
                pcmilerInputs.classList.remove('hidden');
                manualMilesInput.classList.add('hidden');
                manualModeBtn.textContent = 'Switch to Manual Miles';
                manualModeBtn.disabled = false;
            } else {
                pcmilerInputs.classList.add('hidden');
                manualMilesInput.classList.remove('hidden');
                manualModeBtn.textContent = hasKey ? 'Switch to Route Planner' : 'Route Planner (API Key Needed)';
                manualModeBtn.disabled = !hasKey;
            }
        }

        async function handleCopy() {
            const { yourRateLabel, yourRateValue, offerLabel, offerValue, modeLabel, fscTotal, finalTotal } = getSummaryText();
            const isRoutePlannerMode = !pcmilerInputs.classList.contains('hidden');
            const lines = [
                'Freight Calculation Summary:',
                `- Mode: ${modeLabel}`,
                isRoutePlannerMode ? `- Origin: ${stop1Input.value || 'N/A'}` : null,
                isRoutePlannerMode ? `- P/U: ${stop2Input.value || 'N/A'}` : null,
                isRoutePlannerMode ? `- Del.: ${stop3Input.value || 'N/A'}` : null,
                `- Miles: ${(isRoutePlannerMode ? totalMilesOutput.value : milesInput.value) || 'N/A'}`,
                `- Tonnage: ${tonnageInput.value || 'N/A'}`,
                `- FSC: ${fscInput.value || 0}%`,
                '---',
                `- Final Total: $${finalTotal}`,
                `- FSC Amount: $${fscTotal}`,
                '---',
                `- ${yourRateLabel} ${yourRateValue}`,
                `- ${offerLabel} ${offerValue}`
            ].filter(Boolean);
            const summary = lines.join('\n');
            try {
                await navigator.clipboard.writeText(summary);
                copyNotification.textContent = 'Copied to clipboard!';
            } catch {
                copySource.value = summary;
                copySource.select();
                document.execCommand('copy');
                copyNotification.textContent = 'Copied (fallback)!';
            }
            copyNotification.style.opacity = '1';
            setTimeout(() => { copyNotification.style.opacity = '0'; }, 2000);
        }

        function handleEmail() {
            const { offerValue } = getSummaryText();
            const subject = 'Freight Quote';
            const body = `Hello,\n\nFollowing up on your request, here is our all-inclusive quote for the lane:\n\nRate: ${offerValue}\n\nPlease let us know if you have any questions.\n\nThank you,\nThompson Transportation`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function handlePrint() {
            const isRoutePlannerMode = !pcmilerInputs.classList.contains('hidden');
            const currentMiles = isRoutePlannerMode ? totalMilesOutput.value : milesInput.value;
            const data = { mode: currentMode, primaryInput: primaryInput.value, miles: currentMiles, tonnage: tonnageInput.value, fsc: fscInput.value };
            const { yourRateLabel, yourRateValue, offerLabel, offerValue, modeLabel, fscTotal, finalTotal } = getSummaryText(data);
            document.getElementById('print-date').textContent = new Date().toLocaleDateString();
            document.getElementById('print-mode').textContent = modeLabel;
            const printLocations = document.getElementById('print-locations');
            if (isRoutePlannerMode) {
                document.getElementById('print-origin').textContent = stop1Input.value || 'N/A';
                document.getElementById('print-pickup').textContent = stop2Input.value || 'N/A';
                document.getElementById('print-delivery').textContent = stop3Input.value || 'N/A';
                printLocations.classList.remove('hidden');
            } else {
                printLocations.classList.add('hidden');
            }
            document.getElementById('print-miles').textContent = currentMiles || 'N/A';
            document.getElementById('print-tonnage').textContent = tonnageInput.value || 'N/A';
            document.getElementById('print-fsc').textContent = `${fscInput.value || 0}%`;
            document.querySelector('#print-your-rate-row strong').textContent = yourRateLabel;
            document.getElementById('print-your-rate').textContent = yourRateValue;
            document.querySelector('#print-offer-row strong').textContent = offerLabel;
            document.getElementById('print-offer').textContent = offerValue;
            document.getElementById('print-fsc-total').textContent = `$${fscTotal}`;
            document.getElementById('print-final-total').textContent = `$${finalTotal}`;
            window.print();
        }

        // --- Start the application ---
        initialSetup();
    </script>
</body>
</html>
